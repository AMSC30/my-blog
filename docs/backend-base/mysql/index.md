# 索引

索引是一种帮助高效查询数据的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，但是更新、删除、新增的效率不高，同时索引会占用额外的硬盘空间

## 索引分类

|分类|含义|特点|关键字|
|----|----|----|----|
|主键索引|针对于表中主键创建的索引|默认自动创建，只能有一个|PRIMARY|
|唯一索引|避免同一个表中某数据列中的值重复|可以有多个|UNIQUE|
|常规索引|快速定位特定数据|可以有多个|-|
|全文索引|全文索引查找的是文本中的关键词，而不是比较索引中的值|可以有多个|FULLTEXT|

innodb中，根据索引的存储形式，可以分为：

1. 聚集索引l(Clustered Index)：

将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据必须有，而且只有一个

聚集索引选取规则：

- 如果存在主键，主键索引就是聚集索引
- 如果不存在主键，将使用第一个唯一（UNIQUE）索引I作为聚集索引
- 如果表没有主键，或没有合适的唯一索引，则innoDB会自动生成一个rowid作为隐藏的聚集索引l

2. 二级索引(Secondary Index)：

将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键，可以存在多个

## 索引语法

创建索引：create [unique] index 索引名称 on 表名(字段名,...)

查询索引：show index from 表名

删除索引：drop index 索引名 on 表名

建表时，如果之定义一个字段为主键，那么数据库会使用这个字段创建`主键索引`，如果指定了字段对应的值为唯一值，那么也会创建对应的`唯一索引`

## 性能分析

### 执行频率

MySQL客户端连接成功后，通过show[session|global]status命令可以提供服务器状态信息。通过如下指令，可以查看当前数据库的
INSERT、UPDATE、DELETE、SELECT的访问频次：

```bash
SHOW GLOBAL|SESSION STATUS LIKE 'Com____'
```

### 慢查询日志

慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认10秒）的所有sQL语句的日志

MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：

```bash
# 开启MySQL慢日志查询开关
slow_query_log=1

# 设置慢日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志
long_query_time=2
```

## 执行规则

1. 最左前缀法则

如果索引了多列（联合索引），要遵守最左前缀法则，最左前法则指的是查询从索引的最左列开始，并且不跳过索引中的列，如果跳跃某一列，索引将部分失效(后面的字段索引失效)，与字段的位置无关

2. 索引列运算

在索引列上使用了运算，索引列将失效

3. 字符串不加引号

字符串类型列使用时不加引号，索引列将失效

3. 模糊查询

如果仅仅是尾部模糊匹配，索引不会失效，如果是头部模糊匹配，索引失效

4. or连接条件

用or分割开的条件，如果or前的条件中的列有索引l，而后面的列中没有索引，那么涉及的索引都不会被用到

5. SQL提示

SQL提示，是优化数据库的一个重要手段，简单来说，就是在SQL语句中加入一些人为的提示来达到优化操作的目的

use index：建议使用索引

```sql
explain select * from tb_user use index(idx_user_pro) where profession = '软件工程';
```

ignore index：忽略索引

```sql
explain select * from tb_user ignore index(idx_user_pro) where profession = '软件工程';
```

force index：强制使用索引

```sql
explain select * from tb_user force index(idx_user_pro) where profession = '软件工程';
```

6. 前缀索引

当字段类型为字符串（varchar，text等）时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘iO，影响查
询效率。此时可以只将字符串的一部分前缀建立索引，这样可以大大节约索引空间，从而提高索引效率

```sql
create index idx_xxxx on table_name(column(n)) ;
```
