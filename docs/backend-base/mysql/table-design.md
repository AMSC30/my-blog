# 多表设计

## 表间关系

1. 一对多/多对一

一对多主要通过外键约束来进行实现，外键约束是指一个表中的数据必须与另一个表中的数据一致，在多的一方建立外键，指向一的一方的主键

基本语法如下：

- 创建表时添加外键约束：create table 表名称 (字段名称 字段类型 字段约束,... ) CONSTRAINT 外键名称 FOREIGN KEY (外键字段) REFERENCES 主表名称 (主键字段))

- 添加外键约束：alter table 表名称 add constraint 外键名称 foreign key (外键字段) references 主表名称 (主键字段)

物理外键：

使用foreign key指定的外键是物理外键，使用物理外键有个以下几个缺点

- 影响增删改的效率，每次操作都需要检查外键关系
- 不适用于分布式、集群的情况
- 容易引发数据库死锁问题，影响性能

逻辑外键：

在逻辑层中，解决外键关联

2. 一对一

一对一常用于对复杂单表的拆分，将一个单表拆分为多个小的表，在任意一张表中添加外键，关联另一方的主键，并设置为外键为唯一

3. 多对多

多对多的实现通过建立第三张表成为中间表，中间表记录两个外键，分别对应另外两张表

## 多表查询

查询多张表中的数据

### 连接查询

1. 内连接查询：查询两个表的交集

内连接查询有两种语法，分别是隐式内连接和显式内连接

- 隐式内连接语法：select * from 表1,表2 where 表1.字段=表2.字段;

- 显示内连接语法：select * from 表1 [inner] join 表2 on 表1.字段=表2.字段;

2. 左外连接查询：查询左表所有的数据，包含于右表交集的部分，语法如下：

select * from 表1 left [outer] join 表2 on 表1.字段=表2.字段;

3. 右外连接查询：查询右表所有的数据，包含于左表交集的部分，语法如下：

select * from 表1 right [outer] join 表2 on 表1.字段=表2.字段;

### 联合查询

使用union或者union all关键字，将多次查询的结果合并起来，形成一个新的结果集

联合查询的多张表中，列数和字段类型必须保持一致

1. union：对合并后的数据会进行去重

```sql
select 字段列表 from 表名 条件
union
select 字段列表 from 表名 条件
```

2. union all：将所有数据合并在一起

```sql
select 字段列表 from 表名 条件
union all
select 字段列表 from 表名 条件
```

### 子查询

1. 标量子查询：子查询返回的是一个单行单列的值，比如日期、数值、字符串、日期等，语法如下:

select * from 表名 where 字段名 [=|!=|>|>=|<|<=] (select 字段名 from 表名 where 条件);

2. 列子查询：子查询返回的是多行单列的值，子查询的结果常用于条件满足结果值其中一个的情况，语法如下：

select * from 表名 where 字段名 [in|not in] (select 字段名 from 表名 where 条件)

常用操作符：

- in：在指定的集合范围内，为其中一个
- not in：不在指定的集合范围内，不等于其中任何一个
- any、some：常与=、>等比较逻辑一起使用，表示满足任意一个
- all：常与=、>等比较逻辑一起使用，表示满足所有

3. 行子查询：子查询返回的结果是一行多列的值，子查询的结果常用于条件满足多个字段结果的情况，语法如下：

select * from 表名 where (字段1,字段2...) [=|!=|in|not in] (select 字段1,字段2... from 表名 where 条件)

4. 表子查询：子查询返回的结果是一个多行多列的值，子查询的结果常用于作为一张新的表，语法如下：

select e.\* from (select* from 表名 where 条件) as e [inner join|left join|right join|in] 表名 on e.id=表名.id
